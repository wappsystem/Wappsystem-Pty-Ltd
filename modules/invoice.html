<section>
      VmInclude:__BASE__/vmiis/Common-Code/frame/excel.html
</section>
<script>
    function F__ID(){
        //-------------------------------------
        var client_pid=$vm.module_list['client'][0]; //'20000368';
        //-------------------------------------
        var fields="Print|UID,Client,Invoice_Number|UID,Issue_Date,To,Due_Date,Items|UID,GST_Amount,Total_Amount,Payments|UID,Total_Payment,Balance";
        fields+=",Submit Date|DateTime,Submitted by|Author";
        //-------------------------------------
        VmInclude:__BASE__/vmiis/Common-Code/frame/excel.js
        //-------------------------------------
        columns[0]={data:'UID', width:60,renderer:function(instance, td, row, col, prop, value, cellProperties){
            VmInclude:__BASE__/vmiis/Common-Code/hot/render_load_child_module.js|CELL_TEXT|Invoice|MODULE_NAME|invoice_print
        }};
        //-------------------------------------
        columns[1]={data:'Client',type:'autocomplete',source:function(query, process){
            var sqlA="with tb as (select [Item]=Convert(varchar,UID)+'-'+@('Client_Name') from [TABLE-"+client_pid+"])";
            sqlA+=" select top 10 Item from tb where Item like '%'+@S1+'%' ";
            $vm.read_record_auto({query:query,process:process,sql:sqlA,minLength:0});
        }};
        //-------------------------------------
        columns[2]={data:'UID', readOnly:true};
        //-------------------------------------
        columns[3]={data:'Issue_Date',width:120,type: 'date',format: 'DD/MM/YYYY',correctFormat:true};
        //-------------------------------------
        columns[4]={data:'To', width:50,renderer:function(instance, td, row, col, prop, value, cellProperties){
            if(value===null){ td.innerHTML=""; return td;};
            td.innerHTML="<span title='"+value+"'>To...</span>";
            return td;
        }};
        //-------------------------------------
        columns[5]={data:'Due_Date',width:120,type: 'date',format: 'DD/MM/YYYY',correctFormat:true};
        //-------------------------------------
        columns[6]={data:'UID', width:80,renderer:function(instance, td, row, col, prop, value, cellProperties){
            VmInclude:__BASE__/vmiis/Common-Code/hot/render_load_child_module.js|CELL_TEXT|Items...|MODULE_NAME|invoice_items
        }};
        //-------------------------------------
        columns[7]={data:'GST_Amount',type: 'numeric',format: '$ 0,000.00', readOnly:true};
        columns[8]={data:'Total_Amount',type: 'numeric',format: '$ 0,000.00', readOnly:true};
        //-------------------------------------
        columns[9]={data:'UID', width:80,renderer:function(instance, td, row, col, prop, value, cellProperties){
            VmInclude:__BASE__/vmiis/Common-Code/hot/render_load_child_module.js|CELL_TEXT|Pay...|MODULE_NAME|invoice_patments
        }};
        columns[10]={data:'Total_Payment',type: 'numeric',format: '$ 0,000.00', readOnly:true};
        columns[11]={data:'Balance',type: 'numeric',format: '$ 0,000.00', readOnly:true};
        //-------------------------------------
        var before_change=function(changes,source){
    	    if(source=="edit"){
                var I=changes[0][0];
                var p=changes[0][1];
                var v=changes[0][3];
                var hot=$('#excel__ID').handsontable('getInstance');
                if(p==='Client'){
                    var uid=v.split('-')[0];
                    var sql="select Info=@('Address')+'\r\n'+@('Suburb')+' '+@('Postcode')+' '+@('State') from [FORM-"+client_pid+"] where uid=@I1 ";
                    $VmAPI.request({data:{cmd:'query_record',sql:sql},callback:function(res){
                        hot.setDataAtCell(I, 4, res.table[0].Info,'');
                    }});
                }
    	    }
        };
        //-------------------------------------
        var pre_data_process=function(){
            for(var i=0;i<records.length;i++){
                if(records[i].Total_Payment===undefined) records[i].Total_Payment=0;
                if(records[i].Total_Amount===undefined) records[i].Total_Amount=0;
                records[i].Balance=parseFloat(records[i].Total_Payment)-parseFloat(records[i].Total_Amount);
            }
        };
        //-------------------------------------
        var new_pre_data_process=function(){
            $("#excel__ID").handsontable("setDataAtCell", 0, 3, date_to_string_dmy(date_today()));
            $("#excel__ID").handsontable("setDataAtCell", 0, 5, date_to_string_dmy(date_today()));
        };
        //-------------------------------------
        var before_submit=function(record,dbv){
            dbv.PUID='0';
            var uid=record.Client.split('-')[0]; if(uid!=="") dbv.PUID=uid;
            return true;
        };
        //-------------------------------------
        var after_submit=function(I,res,n){
            if(res.uid!==undefined){
                $("#excel__ID").handsontable("setDataAtCell", 0, 0, res.uid);
                $("#excel__ID").handsontable("setDataAtCell", 0, 6, res.uid);
                $("#excel__ID").handsontable("setDataAtCell", 0, 9, res.uid);
            }
        };
        //-------------------------------------
        $('#D__ID').on('back',function(){
            if($vm.vm['__ID'].child_data_changed===1){
                $vm.vm['__ID'].child_data_changed=0;
                grid_data();
            }
        });
        //-------------------------------------
        $('#D__ID').on('load',function(){
              grid_data();
        })
        //-------------------------------------
    }
</script>
<style>
    VmInclude:__BASE__/vmiis/Common-Code/toolbar/toolbar_for_excel.css
    #D__ID{
        font-size:14px;
        font-family: Helvetica, Arial, sans-serif;
    }
</style>
